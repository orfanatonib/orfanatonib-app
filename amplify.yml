version: 1
frontend:
  phases:
    preBuild:
      commands:
        # Garante Node 20 no container do Amplify
        - echo "Using Node $(node -v) before nvm..."
        - nvm install 20
        - nvm use 20
        - node -v
        - corepack enable || true

        # Instala deps (usa npm ci se houver package-lock)
        - if [ -f package-lock.json ]; then npm ci; else npm i; fi

        # Verifica variáveis e gera .env (YAML-safe, sem multiline printf)
        - |
          if [ -z "$VITE_API_URL" ] || [ -z "$VITE_FEED_MINISTERIO_ID" ] || [ -z "$VITE_GOOGLE_CLIENT_ID" ] || [ -z "$VITE_SPECIAL_FAMILY_DAY_ID" ]; then
            echo "Erro: Uma ou mais variáveis de ambiente necessárias não estão definidas no Amplify Console"
            echo "Variáveis necessárias: VITE_API_URL, VITE_FEED_MINISTERIO_ID, VITE_GOOGLE_CLIENT_ID, VITE_SPECIAL_FAMILY_DAY_ID"
            exit 1
          fi
          cat > .env <<EOF
          VITE_API_URL=$VITE_API_URL
          VITE_FEED_MINISTERIO_ID=$VITE_FEED_MINISTERIO_ID
          VITE_GOOGLE_CLIENT_ID=$VITE_GOOGLE_CLIENT_ID
          VITE_SPECIAL_FAMILY_DAY_ID=$VITE_SPECIAL_FAMILY_DAY_ID
          EOF
    build:
      commands:
        - npm run build
  artifacts:
    baseDirectory: dist
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
