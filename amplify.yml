version: 1
frontend:
  phases:
    preBuild:
      commands:
        # Garante Node 20 no container do Amplify
        - echo "Using Node $(node -v) before nvm..."
        - nvm install 20
        - nvm use 20
        - node -v
        - corepack enable || true

        # Instala deps (usa npm ci se houver package-lock)
        - if [ -f package-lock.json ]; then npm ci; else npm i; fi

        # Verifica se as variáveis de ambiente estão definidas
        - |
          if [ -z "$VITE_API_URL" ] || [ -z "$VITE_FEED_MINISTERIO_ID" ] || [ -z "$VITE_GOOGLE_CLIENT_ID" ] || [ -z "$VITE_SPECIAL_FAMILY_DAY_ID" ]; then
            echo "Erro: Uma ou mais variáveis de ambiente necessárias não estão definidas no Amplify Console"
            echo "Variáveis necessárias: VITE_API_URL, VITE_FEED_MINISTERIO_ID, VITE_GOOGLE_CLIENT_ID, VITE_SPECIAL_FAMILY_DAY_ID"
            exit 1
          fi

        # Gera .env para o Vite a partir das vars do Amplify Console (com override por branch)
        - printf "VITE_API_URL=%s\nVITE_FEED_MINISTERIO_ID=%s\nVITE_GOOGLE_CLIENT_ID=%s\nVITE_SPECIAL_FAMILY_DAY_ID=%s\n" \
            "$VITE_API_URL" "$VITE_FEED_MINISTERIO_ID" "$VITE_GOOGLE_CLIENT_ID" "$VITE_SPECIAL_FAMILY_DAY_ID" > .env

        # Log das variáveis (sem valores sensíveis) para debug
        - echo "Variáveis de ambiente configuradas:"
        - echo "VITE_API_URL: $VITE_API_URL"
        - echo "VITE_FEED_MINISTERIO_ID: [CONFIGURADO]"
        - echo "VITE_GOOGLE_CLIENT_ID: [CONFIGURADO]"
        - echo "VITE_SPECIAL_FAMILY_DAY_ID: [CONFIGURADO]"
    build:
      commands:
        - echo "Iniciando build da aplicação..."
        - npm run build
        - echo "Build concluído. Verificando se os arquivos foram gerados..."
        - ls -la dist/
        - |
          if [ ! -d "dist" ] || [ ! -f "dist/index.html" ]; then
            echo "Erro: Build falhou - diretório dist ou index.html não encontrado"
            exit 1
          fi
        - echo "Build bem-sucedido! Arquivos prontos para deploy."
  artifacts:
    baseDirectory: dist
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
